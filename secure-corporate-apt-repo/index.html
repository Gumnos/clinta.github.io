<!doctype html> 
<html lang="en-us"> 
<head>
  <meta charset="utf-8">
  <title>Devops Discoveries</title>
  <meta name="author" content="Clint Armstrong">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="icon" href="/favicon.png" />
  <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png" />

  
  <link rel="stylesheet" href="/style.css" />
</head>

<body class="">

  <div class="header center">
    <ul class="navbar">
	
	
		<li class="navbar"><a class="navbar" href="/">Posts</a></li>
	
	
	
		<li class="navbar"><a class="navbar" href="/resume">Résumé</a></li>
	
	
	
		<li class="navbar"><a class="navbar" href="https://twitter.com/clinta">Twitter</a></li>
	
	
	</ul>
  </div>

  <div class="wrap">
    <header class="mb">
      <h1 class="h2 m-0"><a href="/">Devops Discoveries</a></h1>
      <p class="site-description"></p>
    </header>


<main>
<article class="post">
  <h1><a href="https://clinta.github.io/secure-corporate-apt-repo/" title="Creating a Secure Corporate Apt Repository with Salt">Creating a Secure Corporate Apt Repository with Salt</a></h1>
  <p>There are many reasons an organization could use it&rsquo;s own internal apt repository. But controlling access to this repository for clients that are outside your internal network can be difficult. But if your repository contains proprietary or confidential packages, securing access is not optional. Thankfully apt supports client authentication with SSL certificates. And with the new <a href="http://docs.saltstack.com/en/latest/ref/states/all/salt.states.x509.html">x509</a> module, managing these certificates can be made fully automatic.</p>

<p>The x509 module is not yet in the latest release of salt, so you&rsquo;ll need to manually add it to your custom paths.</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020">cd</span> /srv/salt/_modules
wget https://raw.githubusercontent.com/saltstack/salt/develop/salt/modules/x509.py
<span style="color: #007020">cd</span> /srv/salt/_states
wget https://raw.githubusercontent.com/saltstack/salt/develop/salt/states/x509.py
</pre></div>

<p>Now setup targeting in the top file.</p>

<p>/srv/salt/top.sls</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span>base:
  <span style="color: #4070a0">&#39;ca&#39;</span>:
    - ca.server
  <span style="color: #4070a0">&#39;aptrepo&#39;</span>:
    - aptrepo.server
  <span style="color: #4070a0">&#39;*&#39;</span>:
    - aptrepo.client
</pre></div>

<p>First the CA needs to be configured. It will need to create a CA private key and certificate,
then publish that certificate to the mine where other minions will get it. It will also need
to have a signing policy which allows the apt server and clients to get signed certificates.</p>

<p>Start by creating the signing policy configuraiton.</p>

<p>/srv/salt/pki/files/signing_policies.conf</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span>x509_signing_policies:
  aptrepo_server:
    - minions: <span style="color: #4070a0">&#39;aptrepo&#39;</span>
    - signing_private_key: /etc/pki/aptrepo.key
    - signing_cert: /etc/pki/aptrepo.crt
    - C: US
    - ST: Utah
    - basicConstraints: <span style="color: #4070a0">&quot;critical</span><span style="color: #bb60d5"> </span><span style="color: #4070a0">CA:false&quot;</span>
    - keyUsage: <span style="color: #4070a0">&quot;keyEncipherment,</span><span style="color: #bb60d5"> </span><span style="color: #4070a0">dataEncipherment,</span><span style="color: #bb60d5"> </span><span style="color: #4070a0">keyAgreement,</span><span style="color: #bb60d5"> </span><span style="color: #4070a0">digitalSignature&quot;</span>
    - extendedKeyUsage: <span style="color: #4070a0">&quot;critical</span><span style="color: #bb60d5"> </span><span style="color: #4070a0">serverAuth,clientAuth&quot;</span>
    - subjectKeyIdentifier: hash
    - authorityKeyIdentifier: keyid,issuer:always
    - days_valid: 90
    - copypath: /etc/pki/aptrepo_issued_certs/
  aptrepo_client:
    - minions: <span style="color: #4070a0">&#39;*&#39;</span>
    - signing_private_key: /etc/pki/aptrepo.key
    - signing_cert: /etc/pki/aptrepo.crt
    - C: US
    - ST: Utah
    - basicConstraints: <span style="color: #4070a0">&quot;critical</span><span style="color: #bb60d5"> </span><span style="color: #4070a0">CA:false&quot;</span>
    - keyUsage: <span style="color: #4070a0">&quot;keyEncipherment,</span><span style="color: #bb60d5"> </span><span style="color: #4070a0">dataEncipherment,</span><span style="color: #bb60d5"> </span><span style="color: #4070a0">keyAgreement,</span><span style="color: #bb60d5"> </span><span style="color: #4070a0">digitalSignature&quot;</span>
    - extendedKeyUsage: <span style="color: #4070a0">&quot;critical</span><span style="color: #bb60d5"> </span><span style="color: #4070a0">clientAuth&quot;</span>
    - subjectKeyIdentifier: hash
    - authorityKeyIdentifier: keyid,issuer:always
    - days_valid: 30
    - copypath: /etc/pki/aptrepo_issued_certs/
</pre></div>

<p>Note that in the below state I&rsquo;m triggering a restart of the salt-minion service when the
configuration changes. You&rsquo;ll need another state managing the status of salt-minion for this to work.</p>

<p>/srv/salt/pki/server.sls</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span>/etc/pki:
  file.directory:
    - user: root
    - group: root
    - mode: 700

/etc/salt/minion.d/signing_policies.conf:
      file.managed:
        - source: salt://pki/files/signing_policies.conf
        - listen_in:
          - service: salt-minion

/etc/pki/aptrepo.key:
  x509.private_key_managed:
    - bits: 4096
    - backup: True

/etc/pki/aptrepo.crt:
  x509.certificate_managed:
    - signing_private_key: /etc/pki/aptrepo.key
    - CN: Internal AptRepo
    - C: US
    - ST: Utah
    - basicConstraints: <span style="color: #4070a0">&quot;critical</span><span style="color: #bb60d5"> </span><span style="color: #4070a0">CA:true&quot;</span>
    - keyUsage: <span style="color: #4070a0">&quot;critical</span><span style="color: #bb60d5"> </span><span style="color: #4070a0">cRLSign,</span><span style="color: #bb60d5"> </span><span style="color: #4070a0">keyCertSign&quot;</span>
    - subjectKeyIdentifier: hash
    - authorityKeyIdentifier: keyid,issuer:always
    - days_valid: 1095
    - days_remaining: 30
    - backup: True

/etc/pki/aptrepo_issued_certs:
  file.directory:
    - user: root
    - group: root
    - mode: 700

mine.send:
  module.run: 
    - name: mine.send
    - func: x509.get_pem_entries
    - kwargs:
        glob_path: /etc/pki/*.crt
    - onchanges:
      - x509: /etc/pki/aptrepo.crt
</pre></div>

<p>To create the repository I&rsquo;ll be using reprepro. A good gude to configuring reprepro can be found
<a href="http://vincent.bernat.im/en/blog/2014-local-apt-repositories.htmlGNUPGHOME=gpg">here</a>
Reprepro requires some configuration files to define the distributions and components.
Here are these config files which salt will manage.</p>

<p>/srv/salt/aptrepo/server/files/conf/distributions</p>

<pre><code># Internal Trusty Packages
Origin: Internal #
Label: prod
Suite: trusty-prod
Codename: trusty-prod
Architectures: i386 amd64 source
Components: main
Description: Internal Trusty prod repository
Contents: .gz .bz2
Tracking: keep
SignWith: yes
Log: packages.trusty-prod.log
</code></pre>

<p>/srv/salt/aptrepro/server/files/conf/incoming</p>

<pre><code>Name: incoming
IncomingDir: /srv/packages/incoming
TempDir: /srv/packages/tmp
Default: prod
</code></pre>

<p>/srv/salt/aptrepro/server/files/conf/options</p>

<pre><code>outdir +b/www
logdir +b/logs
gnupghome +b/gpg
</code></pre>

<p>To sign packages added to the repository, gpg keys are required. Personally I opted to create
the GPG keys locally, then copy them to the salt server where they will be managed.</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020">cd</span> /srv/salt/aptrepo/server/files
mkdir gpg
<span style="color: #bb60d5">GNUPGHOME</span><span style="color: #666666">=</span>gpg gpg --gen-key  <span style="color: #60a0b0; font-style: italic"># Make sure and use an empty password</span>
</pre></div>

<p>Another file that needs to be managed is the NGINX configuration file.
Notice the <code>ssl_verify_client on;</code>, this is what enables client authentication.</p>

<p>/srv/salt/aptrepo/server/files/nginx-default</p>

<pre><code>server {
    listen	443;
    ssl on;
    ssl_certificate      /etc/nginx/certs/server.crt;
    ssl_certificate_key  /etc/nginx/certs/server.key;
    ssl_client_certificate /etc/nginx/certs/aptrepo_ca.crt;
    ssl_verify_client on;

    ## Let your repository be the root directory
    root        /srv/packages/www;
    autoindex on;

    ## Always good to log
    access_log  /var/log/nginx/repo.access.log;
    error_log   /var/log/nginx/repo.error.log;
}
</code></pre>

<p>Lastly, a script which will automatically import packages added to the incoming directory.
Salt will create a cron job that regularly runs this script. Now adding packages to the internal
repository is a simple matter of SCPing them to the incoming directory on the aptrepo server.</p>

<p>/srv/salt/aptrepo/server/files/processincoming.sh</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #60a0b0; font-style: italic">#!/bin/sh</span>
<span style="color: #007020">cd</span> /srv/packages

<span style="color: #007020; font-weight: bold">for</span> f in incoming/*.deb
<span style="color: #007020; font-weight: bold">do</span>
	reprepro -C main includedeb trusty-prod <span style="color: #bb60d5">$f</span>
	rm <span style="color: #bb60d5">$f</span>
<span style="color: #007020; font-weight: bold">done</span>
</pre></div>

<p>Now we&rsquo;re ready to put it all together with a salt state.</p>

<p>/srv/salt/aptrepo/server/init.sls</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #60a0b0; font-style: italic"># Install the GPG package needed to sign packages</span>
gnupg:
  pkg.installed: []

<span style="color: #60a0b0; font-style: italic"># Install the dpkg-sig package also needd to sign packages</span>
dpkg-sig:
  pkg.installed: []

<span style="color: #60a0b0; font-style: italic"># Install nginx which will be used to serve the packages</span>
nginx:
  pkg.installed: []
  service.running:
    - enable: True
    - require:
      - pkg: nginx

<span style="color: #60a0b0; font-style: italic"># Add a reprepro user</span>
reprepro:
  user.present:
    - system: True
    - home: /srv/packages
  pkg.installed: []

<span style="color: #60a0b0; font-style: italic"># Configure nginx, restart the nginx service when this file changes</span>
/etc/nginx/sites-available/default:
  file.managed:
    - source: salt://aptrepo/server/files/nginx-default
    - listen_in:
      - service: nginx

<span style="color: #60a0b0; font-style: italic"># Manage the reprepro configuration files</span>
/srv/packages/conf:
  file.recurse:
    - makedirs: True
    - source: salt://aptrepo/server/files/conf
    - user: reprepro
    - group: reprepro
    
<span style="color: #60a0b0; font-style: italic"># Copy the GPG keys that will be used to sign packages</span>
/srv/packages/gpg:
  file.recurse:
    - source: salt://aptrepo/server/files/gpg
    - makedirs: True
    - user: reprepro
    - group: reprepro

<span style="color: #60a0b0; font-style: italic"># Copy the public key into a location where it will be served by NGINX so that clients can get it.</span>
/srv/packages/www/public.gpg.key:
  file.managed:
    - source: salt://aptrepo/server/files/gpg/public.gpg.key
    - makedirs: True
    - user: reprepro
    - group: reprepro

<span style="color: #60a0b0; font-style: italic"># Create a logging directory</span>
/srv/packages/logs:
  file.directory:
    - makedirs: True
    - user: reprepro
    - group: reprepro

<span style="color: #60a0b0; font-style: italic"># Create a directory to hold incoming packages</span>
/srv/packages/incoming/main:
  file.directory:
    - makedirs: True
    - mode: 777
    - user: reprepro
    - group: reprepro

<span style="color: #60a0b0; font-style: italic"># Copy the script that will automatically process incoming packages, and a cron job to run it.</span>
/srv/packages/processincoming.sh:
  file.managed:
    - source: salt://aptrepo/server/files/processincoming.sh
    - user: reprepro
    - group: reprepro
    - mode: 755
  cron.present:
    - user: reprepro
    - minute: <span style="color: #4070a0">&#39;*&#39;</span>
    - require:
      - pkg: reprepro
      - file: /srv/packages/processincoming.sh

<span style="color: #60a0b0; font-style: italic"># Create a certs directory for NGINX</span>
/etc/nginx/certs:
  file.directory:
    - user: root
    - group: root
    - mode: 700

<span style="color: #60a0b0; font-style: italic"># Copy the CA cert to the nginx cert directory</span>
/etc/nginx/certs/aptrepo_ca.crt:
  x509.pem_managed:
    - text: <span style="color: #007020">{{</span> <span style="color: #bb60d5">salt</span><span style="color: #666666">[</span><span style="color: #4070a0">&#39;mine.get&#39;</span><span style="color: #666666">](</span><span style="color: #4070a0">&#39;ca&#39;</span><span style="color: #666666">,</span> <span style="color: #4070a0">&#39;x509.get_pem_entries&#39;</span><span style="color: #666666">)[</span><span style="color: #4070a0">&#39;ca&#39;</span><span style="color: #666666">][</span><span style="color: #4070a0">&#39;/etc/pki/aptrepo.crt&#39;</span><span style="color: #666666">]|</span><span style="color: #06287e">replace</span><span style="color: #666666">(</span><span style="color: #4070a0">&#39;\n&#39;</span><span style="color: #666666">,</span> <span style="color: #4070a0">&#39;&#39;</span><span style="color: #666666">)</span> <span style="color: #007020">}}</span>

<span style="color: #60a0b0; font-style: italic"># Create a private key for the server</span>
<span style="color: #60a0b0; font-style: italic"># The condition below ensures that a key is always created if one doesn&#39;t exist, but if one does</span>
<span style="color: #60a0b0; font-style: italic"># exist, the state will be a prereq and a new key will only be created when the certificate needs</span>
<span style="color: #60a0b0; font-style: italic"># to be renewed.</span>
aptrepo_server-key:
  x509.private_key_managed:
    - name: /etc/nginx/certs/server.key
    - bits: 4096
    - backup: True
    - new: True
    <span style="color: #007020">{%</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #bb60d5">salt</span><span style="color: #666666">[</span><span style="color: #4070a0">&#39;file.file_exists&#39;</span><span style="color: #666666">](</span><span style="color: #4070a0">&#39;/etc/nginx/certs/server.key&#39;</span><span style="color: #666666">)</span> -<span style="color: #007020">%}</span>
    - prereq:
      - x509: aptrepo_server-cert
    <span style="color: #007020">{%</span>- <span style="color: #007020; font-weight: bold">endif</span> <span style="color: #007020">%}</span>
    - listen_in:
      - service: nginx

<span style="color: #60a0b0; font-style: italic"># Create a certificate for the server, signed by the CA.</span>
aptrepo_server-cert:
  x509.certificate_managed:
    - name: /etc/nginx/certs/server.crt
    - ca_server: ca
    - signing_policy: aptrepo_server
    - public_key: /etc/nginx/certs/server.key
    - CN: aptrepo.example.com
    - days_remaining: 30
    - backup: True
    - listen_in:
      - service: nginx
</pre></div>

<p>Now to configure clients to be able to use the new repository. First apt needs to know
that our repository requires a client certificate.</p>

<p>/srv/salt/aptrepo/client/files/45aptrepo-ssl</p>

<pre><code>Acquire::https::aptrepo.example.com {
  Verify-Peer &quot;true&quot;;
  Verify-Host &quot;true&quot;;

  CaInfo &quot;/etc/ssl/aptrepo_ca.crt&quot;;
  SslCert &quot;/etc/ssl/aptrepo_client.crt&quot;;
  SslKey &quot;/etc/ssl/aptrepo_client.key&quot;;
};
</code></pre>

<p>And now a client state to add the repository and generate the certificates clients will
need to use it.</p>

<p>/srv/salt/aptrepo/client/init.sls</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #60a0b0; font-style: italic"># Add our new repository</span>
internal-main-prod:
  pkgrepo.managed:
    - humanname: Internal Repo
    - name: deb https://aptrepo.example.com trusty-prod main
    - key_url: salt://aptrepo/server/files/gpg/public.gpg.key

<span style="color: #60a0b0; font-style: italic"># Add the CA certificate</span>
/etc/ssl/aptrepo_ca.crt:
  x509.pem_managed:
    - text: <span style="color: #007020">{{</span> <span style="color: #bb60d5">salt</span><span style="color: #666666">[</span><span style="color: #4070a0">&#39;mine.get&#39;</span><span style="color: #666666">](</span><span style="color: #4070a0">&#39;ca&#39;</span><span style="color: #666666">,</span> <span style="color: #4070a0">&#39;x509.get_pem_entries&#39;</span><span style="color: #666666">)[</span><span style="color: #4070a0">&#39;ca&#39;</span><span style="color: #666666">][</span><span style="color: #4070a0">&#39;/etc/pki/aptrepo.crt&#39;</span><span style="color: #666666">]|</span><span style="color: #06287e">replace</span><span style="color: #666666">(</span><span style="color: #4070a0">&#39;\n&#39;</span><span style="color: #666666">,</span> <span style="color: #4070a0">&#39;&#39;</span><span style="color: #666666">)</span> <span style="color: #007020">}}</span>

<span style="color: #60a0b0; font-style: italic"># Generate a unique private key</span>
aptrepo_client-key:
  x509.private_key_managed:
    - name: /etc/ssl/aptrepo_client.key
    - bits: 4096
    - backup: True
    - new: True
    <span style="color: #007020">{%</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #bb60d5">salt</span><span style="color: #666666">[</span><span style="color: #4070a0">&#39;file.file_exists&#39;</span><span style="color: #666666">](</span><span style="color: #4070a0">&#39;/etc/ssl/aptrepo_client.key&#39;</span><span style="color: #666666">)</span> -<span style="color: #007020">%}</span>
    - prereq:
      - x509: aptrepo_client-cert
    <span style="color: #007020">{%</span>- <span style="color: #007020; font-weight: bold">endif</span> <span style="color: #007020">%}</span>

<span style="color: #60a0b0; font-style: italic"># Create a certificate signed by CA</span>
aptrepo_client-cert:
  x509.certificate_managed:
    - name: /etc/ssl/aptrepo_client.crt
    - ca_server: ca
    - signing_policy: aptrepo_client
    - public_key: /etc/ssl/aptrepo_client.key
    - CN: <span style="color: #007020">{{</span> <span style="color: #bb60d5">grains</span><span style="color: #666666">[</span><span style="color: #4070a0">&#39;fqdn&#39;</span><span style="color: #666666">]</span> <span style="color: #007020">}}</span>
    - days_remaining: 15
    - backup: True

<span style="color: #60a0b0; font-style: italic"># Add the file configuring apt to use the certificates with this repository</span>
/etc/apt/apt.conf.d/45aptrepo-ssl:
  file.managed:
    - source: salt://aptrepo/client/files/45aptrepo-ssl
</pre></div>

<p>That it, now you have a fully managed internal repository on aptrepo. You can create expose this repository to the internet and only your clients trusted by salt and issued a client certificate will be able to use it.</p>

  <p class="small gray"><time datetime="2015-04-04">2015-04-04</time></p>
</article>
</main>
</div>

</body>
</html>

